@model ProyectoADS1.Models.InformeInspeccion

@{
    ViewData["Title"] = "Informe de Inspección";
}

<style>
    body {
        background-color: #f0f2f5;
    }

    .documento {
        background-color: white;
        max-width: 850px;
        margin: 40px auto;
        padding: 40px 60px;
        border: 1px solid #dcdcdc;
        box-shadow: 0 0 10px rgba(0,0,0,0.15);
        border-radius: 10px;
        font-family: 'Segoe UI', sans-serif;
    }

    .titulo {
        text-align: center;
        font-weight: bold;
        font-size: 22px;
        margin-bottom: 20px;
        text-transform: uppercase;
        color: #333;
    }

    .subtitulo {
        font-weight: bold;
        font-size: 18px;
        color: #2b3a55;
        margin-top: 25px;
        margin-bottom: 10px;
        border-bottom: 2px solid #dcdcdc;
        padding-bottom: 5px;
    }

    .campo {
        margin-bottom: 10px;
    }

    label {
        font-weight: 600;
        margin-bottom: 3px;
    }

    input[readonly], textarea[readonly] {
        background-color: #f8f9fa;
    }

    .firma-section {
        display: flex;
        justify-content: space-between;
        margin-top: 40px;
    }

    .firma-box {
        width: 45%;
        text-align: center;
    }

        .firma-box canvas {
            border: 1px solid #ccc;
            width: 100%;
            height: 150px;
            border-radius: 6px;
        }

    .acciones-firma {
        margin-top: 5px;
    }

    .btn {
        font-size: 14px;
    }

    .id-info {
        text-align: right;
        font-style: italic;
        color: gray;
        margin-bottom: 10px;
    }
</style>
<form asp-action="InformeDeInspeccion" method="post">
    <input type="hidden" asp-for="IdInspeccion" />
    <input type="hidden" asp-for="IdUsuario"/>

    <div class="documento">
        <div class="titulo">Informe de Inspección</div>
        <div class="id-info">ID Informe:@Model.IdInspeccion</div>

        <!-- DATOS DEL CONCESIONARIO -->
        <div class="subtitulo">Datos del Concesionario</div>
        <div class="row">
            <div class="col-md-4 campo">
                <label>RUC</label>
                <input asp-for="IdInspeccionNavigation.Ruc" class="form-control" readonly />
            </div>
            <div class="col-md-4 campo">
                <label>Nombre Comercial</label>
                <input asp-for="IdInspeccionNavigation.NombreComercial" class="form-control" readonly />
            </div>
            <div class="col-md-4 campo">
                <label>Razón Social</label>
                <input asp-for="IdInspeccionNavigation.RazonSocial" class="form-control" readonly />
            </div>
        </div>

        <div class="campo">
            <label>Dirección</label>
            <input asp-for="IdInspeccionNavigation.Direccion" class="form-control" readonly />
        </div>

        <div class="row">
            <div class="col-md-4 campo">
                <label>Departamento</label>
                <input asp-for="IdInspeccionNavigation.Departamento" class="form-control" readonly />
            </div>
            <div class="col-md-4 campo">
                <label>Provincia</label>
                <input asp-for="IdInspeccionNavigation.Provincia" class="form-control" readonly />
            </div>
            <div class="col-md-4 campo">
                <label>Teléfono</label>
                <input asp-for="IdInspeccionNavigation.Telefono" class="form-control" readonly />
            </div>
        </div>

        <div class="campo">
            <label>Email</label>
            <input asp-for="IdInspeccionNavigation.Email" class="form-control" readonly />
        </div>

        <!-- DETALLES DE INSPECCIÓN -->
        <div class="subtitulo">Detalles de Inspección</div>
        <div class="campo">
            <label>Área Supervisada</label>
            <input asp-for="IdInspeccionNavigation.AreaSupervisada" class="form-control" readonly />
        </div>

        <div class="campo">
            <label>Fecha Programada</label>
            <input type="date" asp-for="IdInspeccionNavigation.FechaProgramada" class="form-control" readonly />
        </div>

        <div class="campo">
            <label>Motivo de Inspección</label>
            <textarea asp-for="IdInspeccionNavigation.MotivoInspeccion" class="form-control" rows="3" readonly></textarea>
        </div>

        <div class="campo">
            <label>Observaciones</label>
            <textarea asp-for="IdInspeccionNavigation.ActaInspeccion.Observaciones" class="form-control" rows="3" readonly></textarea>
        </div>

        <div class="campo">
            <label>Recomendaciones</label>
            <textarea asp-for="IdInspeccionNavigation.ActaInspeccion.Recomendaciones" class="form-control" rows="3" readonly></textarea>
        </div>

        <div class="campo">
            <label>Conclusiones</label>
            <textarea asp-for="IdInspeccionNavigation.ActaInspeccion.Conclusiones" class="form-control" rows="3" readonly></textarea>
        </div>

        <!-- FIRMAS -->
        <div class="subtitulo">Firmas</div>
        <div class="firma-section">
            <div class="firma-box">
                <h6>Firma del Supervisor</h6>
                <canvas id="firmaSupervisor"></canvas>
                <div class="acciones-firma">
                    <button type="button" id="btnLimpiarSupervisor" class="btn btn-outline-secondary btn-sm">Limpiar</button>
                    <button type="button" id="btnGuardarSupervisor" class="btn btn-outline-success btn-sm">Guardar</button>
                </div>
                <input type="hidden" asp-for="FirmaSupervisorImagen" id="FirmaSupervisorImagen" />
            </div>

            <div class="firma-box">
                <h6>Firma del Coordinador</h6>
                <canvas id="firmaCoordinador"></canvas>
                <div class="acciones-firma">
                    <button type="button" id="btnLimpiarCoordinador" class="btn btn-outline-secondary btn-sm">Limpiar</button>
                    <button type="button" id="btnGuardarCoordinador" class="btn btn-outline-success btn-sm">Guardar</button>
                </div>
                <input type="hidden" asp-for="FirmaCoordinadorImagen" id="FirmaCoordinadorImagen" />
            </div>
        </div>

        <!-- BOTONES -->
        <hr />
        <div class="d-flex mt-3">
            <a class="btn btn-secondary" asp-action="Index" asp-controller="Inspeccion">Regresar</a>
            <button type="submit" class="btn btn-primary ms-auto">Guardar</button>
        </div>
    </div>
</form>




@section Scripts {
    <script>
        function setupSignature(canvasId, clearId, saveId, inputId, existingDataUrl) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext("2d");
            let drawing = false;

            // ✅ Si hay una firma guardada, dibujarla
            if (existingDataUrl && existingDataUrl.startsWith("data:image")) {
                const img = new Image();
                img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                img.src = existingDataUrl;
            }

            canvas.addEventListener("mousedown", () => drawing = true);
            canvas.addEventListener("mouseup", () => drawing = false);
            canvas.addEventListener("mousemove", draw);

            function draw(e) {
                if (!drawing) return;
                ctx.lineWidth = 2;
                ctx.lineCap = "round";
                ctx.strokeStyle = "#000";
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(e.offsetX, e.offsetY);
            }

            document.getElementById(clearId).addEventListener("click", () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });

            document.getElementById(saveId).addEventListener("click", () => {
                const dataUrl = canvas.toDataURL("image/png");
                document.getElementById(inputId).value = dataUrl;
                alert("Firma guardada correctamente.");
            });
        }

        setupSignature(
            "firmaSupervisor",
            "btnLimpiarSupervisor",
            "btnGuardarSupervisor",
            "FirmaSupervisorImagen",
            '@Html.Raw(Model.FirmaSupervisorImagen != null ? Model.FirmaSupervisorImagen : "")'
        );

        setupSignature(
            "firmaCoordinador",
            "btnLimpiarCoordinador",
            "btnGuardarCoordinador",
            "FirmaCoordinadorImagen",
            '@Html.Raw(Model.FirmaCoordinadorImagen != null ? Model.FirmaCoordinadorImagen : "")'
        );

    </script>
}
